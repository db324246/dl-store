var t={deepClone:function t(e){if(!e||"object"!=typeof e)return e;const s=e.constructor===Array?[]:{};return Object.keys(e).forEach((r=>{e[r]&&"object"==typeof e[r]?s[r]=t(e[r]):s[r]=e[r]})),s},typeOf:function(t){return Object.prototype.toString.call(t).slice(8,-1).toLowerCase()}};const{deepClone:e}=t;class s{constructor(t,e){this.key=t,this.parentStore=e,this.oldVal=null,this.dependences=[]}add(t){this.dependences.push(t),s.add(t)}emit(t){const s=e(t);this.dependences.forEach((t=>t(s,this.oldVal))),this.oldVal=e(t);const r=this.key.split("."),i=[];r.pop(),r.forEach((t=>{i.push([...i,t].join("."))})),i.forEach((t=>{const e=this.parentStore.__watcherMap__.get(t);e&&e.deepEmit()}))}deepEmit(){const t=this.key.split(".");let s="";t.forEach((t=>{s=s?s[t]:this.parentStore.__datebase__[t]}));const r=e(s);this.dependences.forEach((t=>t.deep&&t(r,this.oldVal))),this.oldVal=e(s)}remove(t){const e=this.dependences.findIndex((e=>e.key===t));e>=0&&(this.dependences.splice(e,1),s.remove(t))}clear(){this.dependences.forEach((t=>{s.remove(t.key)})),this.dependences=[]}}s.dependences=[],s.add=function(t){this.dependences.push(t)},s.remove=function(t){const e=this.dependences.findIndex((e=>e.key===t));e>=0&&this.dependences.splice(e,1)};var r=s;const i=r,{deepClone:o,typeOf:n}=t;var a=class{constructor({config:t,store:e,parentStore:s}){let r=t.state||{};if(r="function"===n(r)?r():r,"object"!==n(r))throw new Error("state must be a object or a funtion with return a Object");const i=o(r);this.actionState=!1,this.store=e,this.parentStore=s||e,this.parentStore.setDatabase(i),this.proxer=this.recursionProxy(i)}recursionProxy(t,e=""){if("object"!=typeof t)return t;for(const[s,r]of Object.entries(t)){const i=e?`${e}.${s}`:s;t[s]=this.recursionProxy(r,i)}return this.createProxy(t,e)}createProxy(t,e){if("object"!=typeof t)return t;const s=this.parentStore,r=s.__watcherMap__;return new Proxy(t,{get:(t,o)=>{const n=t[o],a=e?`${e}.${o}`:o,c=r.has(a)?r.get(a):new i(a,s);if(s.__getter__.getterState){const t=s.__getter__.gennerateMemoryFn(n);c.add(t),r.set(a,c)}else if(this.store.modules){const t=Object.values(this.store.modules).find((t=>t.__getter__.getterState));if(!t)return n;this.store.__getter__;const e=t.__getter__,s=this.store.__watcherMap__,r=s.has(o)?s.get(o):new i(o,this.store),a=e.gennerateMemoryFn(n);r.add(a),s.set(o,r)}return n},set:(t,o,n)=>{if(!this.actionState)throw new Error("set state data must use action");const a=t[o],c=s.__hTime__;if(c&&c.addAction({target:t,key:o,val:n,oldVal:a,type:"set"}),n===a)return!0;t[o]=this.createProxy(n);const h=e?`${e}.${o}`:o,_=r.has(h)?r.get(h):new i(h,s);return _.emit(n,a),r.set(h,_),!0},deleteProperty:(t,o)=>{if(!this.actionState)throw new Error("delete state data must use action");const a=t[o];Reflect.deleteProperty(t,o);const c=s.__hTime__;c&&c.addAction({target:t,key:o,oldVal:a,type:"delete"});const h=e?`${e}.${o}`:o,_=r.has(h)?r.get(h):new i(h,s);return"object"===n(t)&&_.emit(),r.delete(h),!0}})}};const c=r,{deepClone:h,typeOf:_}=t;var d=class{constructor({config:t,store:e,parentStore:s}){let r=t.watch||{};if(r="function"===_(r)?r():r,"object"!==_(r))throw new Error("watch must be a object or a funtion with return a Object");this.store=e,this.parentStore=s||e,this.watchObj=h(r),this.watchKeyDataMap=new Map;for(const[t,e]of Object.entries(this.watchObj))this.addWatch(t,e)}addWatch(t,e){const s=_(e),r=this.parentStore.__watcherMap__,i=r.has(t)?r.get(t):new c(t,this.parentStore),o=Date.now();if("object"===s){this.watchKeyDataMap.set(e,o);const s=function(...t){e.handler&&e.handler.call(this,...t)};s.key=`${o}-watch-fn`,s.deep=e.deep,i.add(s.bind(this.parentStore)),e.immediate&&this.handleImmediate(t,s)}else{if("function"!==s)throw new Error(`${t} of watch must be a object or a funtion`);{this.watchKeyDataMap.set(e,o);const t=function(...t){e&&e.call(this,...t)};t.key=`${o}-watch-fn`,i.add(t.bind(this.parentStore))}}r.set(t,i)}handleImmediate(t,e){const s=t.split(".");let r="";s.forEach((t=>{r=r?r[t]:this.parentStore.__datebase__[t]}));e(h(r))}removeWatch(t,e){const s=this.parentStore.__watcherMap__.get(t);if(!s)return;const r=this.watchKeyDataMap.get(e);r?s.remove(`${r}-watch-fn`):s.clear()}};var f=class{defineProperty(t,e,s){Object.defineProperty(this,t,{value:e,enumerable:s,writable:!1,configurable:!1})}};var p={InitHistory:class{constructor(){this.currentTime=0,this.historyList=[]}addHistory(t){this.currentTime<this.historyList.length&&(this.historyList=this.historyList.slice(0,this.currentTime)),this.historyList.splice(this.currentTime,1,t),this.currentTime++,this.historyList.length>100&&(this.historyList.shift(),this.currentTime--)}removeHistory(t){const e=this.historyList.findIndex((e=>e.key===t));if(e<0)return;this.historyList.splice(e,1);this.currentTime-1>=e&&this.currentTime--}prevTime(){if(0===this.currentTime)return;this.currentTime-=1;const t=this.historyList[this.currentTime];t&&t.actions.forEach((t=>{switch(t.type){case"set":case"delete":t.target[t.key]=t.oldVal}}))}nextTime(){if(this.currentTime===this.historyList.length)return;const t=this.historyList[this.currentTime];this.currentTime+=1,t&&t.actions.forEach((t=>{switch(t.type){case"set":t.target[t.key]=t.val;break;case"delete":Reflect.deleteProperty(t.target,t.key)}}))}},HistoryTime:class{constructor(t){this.key=Date.now(),this.store=t.store,this.dispatchName=t.dispatchName,this.actions=[],this.store.__history__.addHistory(this)}addAction({target:t,key:e,val:s,oldVal:r,type:i}){this.actions.push({target:t,key:e,val:s,oldVal:r,type:i})}selfCheck(){this.actions.length||this.store.__history__.removeHistory(this.key)}}};const l=f,{HistoryTime:y}=p,{deepClone:u,typeOf:g}=t;var w=class extends l{constructor({config:t,store:e,parentStore:s}){super();let r=t.actions||{};if(r="function"===g(r)?r():r,"object"!==g(r))throw new Error("actions must be a object or a funtion with return a Object");this.store=e,this.parentStore=s||e,this.actionsObj=u(r),this.defineProperty.call(this.parentStore,"dispatch",this.dispatch.bind(this),!0)}dispatch(t,...e){if(t.includes("/")){const[s,r]=t.split("/");return this.store.modules[s].dispatch(r,...e)}const s=this.parentStore;s.__state__.actionState=!0,this.createHistory(t);let r=null;try{const s=this.actionsObj[t];if(!s)throw new Error(`actions has not function named ${t}`);r=s(this.actionContext(),...e)}catch(t){}return this.destroyHistory(),r instanceof Promise?r.then((()=>{s.__state__.actionState=!1})):(s.__state__.actionState=!1,r)}actionContext(){const t=this.parentStore,e=this;return{state:t.state,getters:t.getters,rootState:this.store.state,rootGetters:this.store.getters,__history__:this.store.__history__,addWatch:t.addWatch.bind(t),removeWatch:t.removeWatch.bind(t),dispatch(...t){const s=e.dispatch(...t);return s instanceof Promise?s.then((()=>{e.__state__.actionState=!0})):(e.__state__.actionState=!0,s)}}}createHistory(t){const e=new y({store:this.store,dispatchName:t});Reflect.set(this.store,"__hTime__",e)}destroyHistory(){this.store.__hTime__.selfCheck(),Reflect.deleteProperty(this.store,"__hTime__")}};const b=r,m=f,{deepClone:S,typeOf:j}=t;var P=class extends m{constructor({config:t,store:e,parentStore:s}){super();let r=t.getters||{};if(r="function"===j(r)?r():r,"object"!==j(r))throw new Error("getters must be a object or a funtion with return a Object");this.store=e,this.parentStore=s||e,this.gettersObj=S(r),this.gettersData={}}init(){const t={},e=this.parentStore;this.defineProperty.call(e,"getters",t,!0);for(const[s,r]of Object.entries(this.gettersObj)){if("function"!==j(r))throw new Error(`${s} of getters must be a function`);if(Reflect.has(e.state,r))throw new Error(`state already has param named ${s}`);this.getterState=!0,this.getterStateKey=s;const i=r({state:e.state,getters:e.getters,rootState:this.store.state,rootGetters:this.store.getters});b.dependences.filter((t=>t.key===`${s}-getter-fn`)).forEach((t=>{t.lastRes=i})),Reflect.set(this.gettersData,s,i),Object.defineProperty(t,s,{configurable:!1,enumerable:!0,get:()=>{const t=this.gettersData[s];if(e.__getter__.getterState){const r=e.__watcherMap__,i=r.has(s)?r.get(s):new b(s,e),o=e.__getter__.gennerateMemoryFn(t);i.add(o),r.set(s,i)}else if(this.store.modules){const e=Object.values(this.store.modules).find((t=>t.__getter__.getterState));if(!e)return t;this.store.__getter__;const r=e.__getter__,i=this.store.__watcherMap__,o=i.has(s)?i.get(s):new b(s,this.store),n=r.gennerateMemoryFn(t);o.add(n),i.set(s,o)}return t},set(t){throw new Error("getters data is readonly")}}),this.parentStore.__watcherMap__.set(s,new b(s,this.parentStore)),this.getterStateKey="",this.getterState=!1}this.parentStore.setDatabase(this.gettersData)}gennerateMemoryFn(t){const e=this,s=this.getterStateKey,r=function(i){if(t===i)return r.lastRes;t=i;const o=(0,e.gettersObj[s])({state:e.parentStore.state,getters:e.parentStore.getters,rootState:e.store.state,rootGetters:e.store.getters});r.lastRes=o,Reflect.set(e.gettersData,s,o);const n=e.parentStore.__watcherMap__.get(s);return n&&n.emit(o),o};return r.key=`${s}-getter-fn`,r}};const O=a,v=d,M=w,E=P,k=f,{deepClone:$,typeOf:T}=t;class x extends k{constructor(t,e){if("object"!==T(t))throw new Error("module config must be a object");super(t),this.defineProperty("__config__",$(t)),this.defineProperty("__store__",e),this.defineProperty("__watcherMap__",new Map),this.defineProperty("__datebase__",{}),this.defineProperty("__state__",new O({config:t,store:e,parentStore:this})),this.defineProperty("state",this.__state__.proxer,!0),this.defineProperty("__getter__",new E({config:t,store:e,parentStore:this}))}init(){const t=this.__store__,e=this.__config__;this.__getter__.init(),this.defineProperty("__actions__",new M({config:e,store:t,parentStore:this})),this.defineProperty("__watch__",new v({config:e,store:t,parentStore:this})),this.defineProperty("watch",this.__watch__.watchObj,!0),this.defineProperty("addWatch",this.__watch__.addWatch.bind(this.__watch__),!0),this.defineProperty("removeWatch",this.__watch__.removeWatch.bind(this.__watch__),!0)}setDatabase(t={}){for(const[e,s]of Object.entries(t))this.defineProperty.call(this.__datebase__,e,s,!0)}registerGlobleActions(t){const e=this.__store__.__actions__.actionsObj,s=this.__actions__.actionsObj;for(const[r,i]of Object.entries(s))Reflect.set(e,`${t}/${r}`,i)}}function W(t,e){const s=this,r=new x(e,s);Reflect.set(s.modules,t,r),r.init(),r.registerGlobleActions(t),s.defineProperty(`__${t}_state__`,r.state,!0),s.defineProperty(`__${t}_getters__`,r.getters,!0),s.defineProperty(`__${t}_dispatch__`,r.dispatch.bind(r),!0),s.defineProperty(`__${t}_addWatch__`,r.addWatch.bind(r),!0),s.defineProperty(`__${t}_removeWatch__`,r.removeWatch.bind(r),!0)}var D={initModuleFn:function(t,e){let s=t.modules||{};if(s="function"===T(s)?s():s,"object"!==T(s))throw new Error("modules must be a object or a funtion with return a Object");e.defineProperty("modules",{});for(const[t,r]of Object.entries(s))W.call(e,t,r)},registerModule:W};const L=a,C=d,H=w,R=P,{InitHistory:V}=p,{initModuleFn:F,registerModule:I}=D,K=f,{typeOf:A}=t;var G=class extends K{constructor(t={}){if("object"!==A(t))throw new Error("config must be a object");super(t),this.defineProperty("__watcherMap__",new Map),this.defineProperty("__datebase__",{}),this.defineProperty("__state__",new L({config:t,store:this})),this.defineProperty("state",this.__state__.proxer,!0),this.defineProperty("__getter__",new R({config:t,store:this})),this.__getter__.init(),this.defineProperty("__actions__",new H({config:t,store:this})),F(t,this),this.defineProperty("__watch__",new C({config:t,store:this})),this.defineProperty("watch",this.__watch__.watchObj,!0),this.defineProperty("addWatch",this.__watch__.addWatch.bind(this.__watch__),!0),this.defineProperty("removeWatch",this.__watch__.removeWatch.bind(this.__watch__),!0),this.defineProperty("__history__",new V,!0)}registerModule=I;setDatabase(t={}){for(const[e,s]of Object.entries(t))this.defineProperty.call(this.__datebase__,e,s,!0)}};export{G as default};
